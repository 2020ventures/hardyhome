<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Dashboard - Hardy Home and Garden</title>
    
    <!-- Primary Meta Tags -->
    <meta name="title" content="Hardy - The Community Garden in Your Pocket">
    <meta name="description" content="Connect with neighbors to share your garden's harvest. Free local produce exchange in Kenosha & Racine Counties.">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://hardyhome.us/">
    <meta property="og:title" content="Hardy - The Community Garden in Your Pocket">
    <meta property="og:description" content="Connect with neighbors to share your garden's harvest. Free local produce exchange in Kenosha & Racine Counties.">
    <meta property="og:image" content="https://hardyhome.us/img/hardy-social-preview.png">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600;700&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Hardy Config -->
    <script src="../hardy-config.js"></script>
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-CJ4MS44MBB"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-CJ4MS44MBB');
    </script>
    
    <style>
        /* CSS Reset */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        /* Variables */
        :root {
            /* Brand Colors */
            --hardy-green: #4CAF50;
            --hardy-green-dark: #388E3C;
            --hardy-green-light: #A5D6A7;
            
            /* Supporting Colors */
            --text-primary: #212121;
            --text-secondary: #757575;
            --text-light: #FFFFFF;
            --background-light: #F9F9F9;
            --background-white: #FFFFFF;
            --border-color: #E0E0E0;
            
            /* Spacing */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --spacing-xxl: 3rem;
            
            /* Border Radius */
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            
            /* Box Shadows */
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            --shadow-md: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
        }
        
        /* Base Styles */
        body {
            font-family: 'Open Sans', sans-serif;
            color: var(--text-primary);
            line-height: 1.6;
            background-color: var(--background-light);
        }
        
        a {
            color: var(--hardy-green);
            text-decoration: none;
        }
        
        a:hover {
            color: var(--hardy-green-dark);
        }
        
        ul {
            list-style: none;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 var(--spacing-md);
        }
        
        /* Typography */
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Lora', serif;
            font-weight: 700;
            line-height: 1.2;
            margin-bottom: var(--spacing-md);
        }
        
        h1 {
            font-size: 2.5rem;
        }
        
        h2 {
            font-size: 2rem;
        }
        
        h3 {
            font-size: 1.5rem;
        }
        
        p {
            margin-bottom: var(--spacing-md);
        }
        
        /* Buttons */
        .btn {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-md);
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-size: 1rem;
            text-decoration: none;
        }
        
        .btn-primary {
            background-color: var(--hardy-green);
            color: var(--text-light);
        }
        
        .btn-primary:hover {
            background-color: var(--hardy-green-dark);
            color: var(--text-light);
        }
        
        .btn-secondary {
            background-color: var(--text-light);
            color: var(--hardy-green);
            border: 2px solid var(--hardy-green);
        }
        
        .btn-secondary:hover {
            background-color: var(--hardy-green-light);
            color: var(--hardy-green-dark);
        }
        
        .btn-outline {
            background-color: transparent;
            color: var(--text-secondary);
            border: 2px solid var(--border-color);
        }
        
        .btn-outline:hover {
            border-color: var(--hardy-green);
            color: var(--hardy-green);
        }
        
        .btn-small {
            padding: var(--spacing-xs) var(--spacing-md);
            font-size: 0.9rem;
        }
        
        .btn-block {
            display: block;
            width: 100%;
        }
        
        /* Header */
        .site-header {
            background-color: var(--background-white);
            box-shadow: var(--shadow-sm);
            padding: var(--spacing-md) 0;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .site-header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            max-width: 150px;
        }
        
        .logo img {
            width: 100%;
            height: auto;
        }
        
        .main-nav ul {
            display: flex;
            gap: var(--spacing-lg);
        }
        
        .main-nav a {
            color: var(--text-primary);
            font-weight: 600;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            transition: all 0.3s ease;
        }
        
        .main-nav a:hover,
        .main-nav a.active {
            color: var(--hardy-green);
            background-color: var(--hardy-green-light);
        }
        
        .user-actions {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }
        
        .user-menu {
            position: relative;
        }
        
        .user-menu-btn {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            background: none;
            border: 2px solid var(--border-color);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .user-menu-btn:hover {
            border-color: var(--hardy-green);
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            background-color: var(--hardy-green-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--hardy-green-dark);
            font-weight: bold;
        }
        
        /* User Dropdown Menu */
        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: var(--spacing-xs);
            background-color: var(--background-white);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            min-width: 200px;
            z-index: 1001;
            display: none;
            border: 1px solid var(--border-color);
        }
        
        .user-dropdown.show {
            display: block;
        }
        
        .user-dropdown a,
        .user-dropdown button {
            display: block;
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            text-align: left;
            color: var(--text-primary);
            background: none;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
            font-family: inherit;
        }
        
        .user-dropdown a:hover,
        .user-dropdown button:hover {
            background-color: var(--background-light);
            color: var(--hardy-green);
        }
        
        .user-dropdown .divider {
            height: 1px;
            background-color: var(--border-color);
            margin: var(--spacing-xs) 0;
        }
        
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-primary);
        }
        
        /* Dashboard Specific */
        .dashboard-header {
            background-color: var(--background-white);
            padding: var(--spacing-xl) 0;
            margin-bottom: var(--spacing-xl);
            border-bottom: 1px solid var(--border-color);
        }
        
        .dashboard-welcome {
            text-align: center;
        }
        
        .welcome-text h1 {
            color: var(--hardy-green-dark);
            margin-bottom: var(--spacing-sm);
        }
        
        .member-info {
            color: var(--text-secondary);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: var(--spacing-md);
            flex-wrap: wrap;
        }
        
        .neighborhood-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            background-color: var(--hardy-green-light);
            color: var(--hardy-green-dark);
            padding: var(--spacing-xs) var(--spacing-md);
            border-radius: var(--radius-sm);
            font-weight: 600;
        }
        
        /* Tab Navigation */
        .dashboard-tabs {
            display: flex;
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-xl);
            border-bottom: 2px solid var(--border-color);
        }
        
        .tab-btn {
            background: none;
            border: none;
            padding: var(--spacing-md) var(--spacing-lg);
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .tab-btn:hover {
            color: var(--hardy-green);
        }
        
        .tab-btn.active {
            color: var(--hardy-green);
        }
        
        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: var(--hardy-green);
        }
        
        .tab-btn .badge {
            background-color: var(--hardy-green);
            color: white;
            padding: 0.2rem 0.4rem;
            border-radius: 10px;
            font-size: 0.75rem;
            margin-left: var(--spacing-xs);
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: var(--spacing-xl);
            margin-bottom: var(--spacing-xl);
        }
        
        .dashboard-card {
            background-color: var(--background-white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            padding: var(--spacing-xl);
            transition: all 0.3s ease;
        }
        
        .dashboard-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
        }
        
        .card-header h3 {
            margin-bottom: 0;
            color: var(--hardy-green-dark);
        }
        
        .card-icon {
            font-size: 1.5rem;
            color: var(--hardy-green);
        }
        
        /* V2 Simplified Messages Styles */
        .messages-container {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: var(--spacing-lg);
            height: 600px;
            background-color: var(--background-white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
        }
        
        .conversations-list {
            background-color: var(--background-light);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .conversations-header {
            padding: var(--spacing-md);
            background-color: var(--background-white);
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            flex-shrink: 0;
        }
        
        #conversations-content {
            flex: 1;
            overflow-y: auto;
        }
        
        .conversation-item {
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .conversation-item:hover {
            background-color: var(--background-white);
        }
        
        .conversation-item.active {
            background-color: var(--hardy-green-light);
        }
        
        .conversation-item.unread {
            font-weight: 600;
        }
        
        .conversation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-xs);
        }
        
        .conversation-user {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .conversation-time {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .conversation-listing {
            font-size: 0.9rem;
            color: var(--hardy-green-dark);
            margin-bottom: var(--spacing-xs);
        }
        
        .conversation-preview {
            font-size: 0.9rem;
            color: var(--text-secondary);
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        
        /* Message View */
        .message-view {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }
        
        .message-header {
            padding: var(--spacing-md);
            background-color: var(--background-white);
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        
        .message-header h3 {
            margin-bottom: var(--spacing-xs);
            font-size: 1.2rem;
        }
        
        .message-listing-info {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .messages-area {
            flex: 1;
            padding: var(--spacing-md);
            overflow-y: auto;
            overflow-x: hidden;
            background-color: var(--background-light);
            min-height: 0;
            scroll-behavior: smooth;
        }
        
        .messages-area::-webkit-scrollbar {
            width: 8px;
        }
        
        .messages-area::-webkit-scrollbar-track {
            background: var(--background-light);
        }
        
        .messages-area::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }
        
        .messages-area::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }
        
        .message {
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: flex-start;
            gap: var(--spacing-sm);
        }
        
        .message.sent {
            flex-direction: row-reverse;
        }
        
        .message-avatar {
            width: 32px;
            height: 32px;
            background-color: var(--hardy-green-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--hardy-green-dark);
            font-weight: bold;
            font-size: 0.9rem;
            flex-shrink: 0;
        }
        
        .message-content {
            max-width: 70%;
        }
        
        .message-bubble {
            background-color: var(--background-white);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .message.sent .message-bubble {
            background-color: var(--hardy-green);
            color: white;
        }
        
        .message-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: var(--spacing-xs);
        }
        
        .message-input-area {
            padding: var(--spacing-md);
            background-color: var(--background-white);
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        
        .message-input-form {
            display: flex;
            gap: var(--spacing-sm);
        }
        
        .message-input {
            flex: 1;
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 0.95rem;
            font-family: inherit;
            resize: none;
        }
        
        .message-input:focus {
            outline: none;
            border-color: var(--hardy-green);
        }
        
        .send-btn {
            padding: var(--spacing-sm) var(--spacing-md);
            background-color: var(--hardy-green);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .send-btn:hover {
            background-color: var(--hardy-green-dark);
        }
        
        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .no-conversation-selected {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            text-align: center;
        }
        
        /* Mobile Toggle */
        .mobile-message-toggle {
            display: none;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-md);
            background-color: var(--background-white);
            padding: var(--spacing-xs);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
        }

        .mobile-message-toggle .toggle-btn {
            background: none;
            border: none;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-sm);
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
            font-size: 14px;
        }

        .mobile-message-toggle .toggle-btn.active {
            background-color: var(--hardy-green);
            color: white;
        }
        
        /* Listings Management */
        .listings-section {
            margin-top: var(--spacing-lg);
        }
        
        .listing-item {
            background-color: var(--background-light);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: var(--spacing-md);
        }
        
        .listing-info {
            flex: 1;
        }
        
        .listing-title {
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
        }
        
        .listing-meta {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .listing-actions {
            display: flex;
            gap: var(--spacing-sm);
        }
        
        .listing-type {
            display: inline-block;
            padding: 0.2rem 0.4rem;
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
        }
        
        .listing-type.offering {
            background-color: var(--hardy-green-light);
            color: var(--hardy-green-dark);
        }
        
        .listing-type.seeking {
            background-color: #FFF176;
            color: #F57F17;
        }
        
        .empty-state {
            text-align: center;
            padding: var(--spacing-xxl) var(--spacing-md);
            color: var(--text-secondary);
        }
        
        .empty-state i {
            font-size: 3rem;
            color: var(--border-color);
            margin-bottom: var(--spacing-md);
        }
        
        /* Settings Grid */
        .settings-grid {
            display: grid;
            gap: var(--spacing-md);
        }
        
        /* Footer */
        .site-footer {
            background-color: var(--text-primary);
            color: var(--text-light);
            padding: var(--spacing-xxl) 0 var(--spacing-md);
            margin-top: var(--spacing-xxl);
        }
        
        .footer-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-xxl);
            margin-bottom: var(--spacing-xl);
        }
        
        .footer-logo {
            margin-bottom: var(--spacing-md);
            max-width: 150px;
        }
        
        .footer-logo img {
            width: 100%;
            height: auto;
        }
        
        .footer-links h3 {
            margin-bottom: var(--spacing-md);
            font-size: 1.2rem;
            color: var(--text-light);
        }
        
        .footer-links ul li {
            margin-bottom: var(--spacing-sm);
        }
        
        .footer-links a {
            color: var(--text-light);
            opacity: 0.8;
        }
        
        .footer-links a:hover {
            opacity: 1;
            color: var(--hardy-green-light);
        }
        
        .footer-bottom {
            text-align: center;
            padding-top: var(--spacing-lg);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .main-nav > ul {
                display: none !important;
            }
            
            .user-actions {
                display: none !important;
            }
            
            .mobile-menu-btn {
                display: block;
            }
            
            .mobile-message-toggle {
                display: grid !important;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .member-info {
                flex-direction: column;
                gap: var(--spacing-sm);
            }
            
            .listing-item {
                flex-direction: column;
                align-items: stretch;
            }
            
            .listing-actions {
                justify-content: stretch;
            }
            
            .listing-actions .btn {
                flex: 1;
            }
            
            .messages-container {
                grid-template-columns: 1fr;
                height: 500px;
                gap: 0;
            }
            
            .conversations-list {
                display: none;
                border-right: none;
                height: 100%;
                border-radius: var(--radius-md);
            }
            
            .conversations-list.mobile-show {
                display: flex;
                flex-direction: column;
            }
            
            .message-view {
                display: none;
                height: 100%;
            }
            
            .message-view.mobile-show {
                display: flex;
                flex-direction: column;
            }
            
            .dashboard-tabs {
                flex-wrap: wrap;
            }
            
            .tab-btn {
                padding: var(--spacing-sm) var(--spacing-md);
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <header class="site-header">
        <div class="container">
            <div class="logo">
                <a href='/'>
                    <img src="../img/logo.svg" alt="Hardy Home and Garden">
                </a>
            </div>
            <nav class="main-nav">
                <ul class="nav-links">
                    <li><a href='/'>Home</a></li>
                    <li><a href='/pages/browse'>Browse</a></li>
                    <li><a class='active' href='/pages/dashboard'>My Dashboard</a></li>
                </ul>
            </nav>
            <div class="user-actions">
                <div class="user-menu">
                    <button class="user-menu-btn" id="user-menu-btn">
                        <div class="user-avatar" id="user-avatar">?</div>
                        <span id="user-name">User</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="user-dropdown" id="user-dropdown">
                        <a href='/pages/browse'>
                            <i class="fas fa-search"></i> Browse Listings
                        </a>
                        <a href='/pages/create'>
                            <i class="fas fa-plus"></i> Create Listing
                        </a>
                        <div class="divider"></div>
                        <a href='/pages/support'>
                            <i class="fas fa-heart"></i> Support Hardy
                        </a>
                        <div class="divider"></div>
                        <button onclick="signOut()">
                            <i class="fas fa-sign-out-alt"></i> Sign Out
                        </button>
                    </div>
                </div>
            </div>
            <button class="mobile-menu-btn">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </header>

    <div class="dashboard-header">
        <div class="container">
            <div class="dashboard-welcome">
                <div class="welcome-text">
                    <h1>Welcome back, <span id="welcome-name">Friend</span>!</h1>
                    <div class="member-info">
                        <span class="neighborhood-badge">
                            <i class="fas fa-map-marker-alt"></i>
                            <span id="user-neighborhood">Your Neighborhood</span>
                        </span>
                        <span>Member since <span id="member-date">January 2025</span></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Tab Navigation -->
        <div class="dashboard-tabs">
            <button class="tab-btn active" onclick="switchTab('overview', event)">
                <i class="fas fa-th-large"></i> Overview
            </button>
            <button class="tab-btn" onclick="switchTab('listings', event)">
                <i class="fas fa-leaf"></i> My Listings
            </button>
            <button class="tab-btn" onclick="switchTab('messages', event)">
                <i class="fas fa-comments"></i> Messages
                <span class="badge" id="unread-badge" style="display: none;">0</span>
            </button>
            <button class="tab-btn" onclick="switchTab('settings', event)">
                <i class="fas fa-cog"></i> Settings
            </button>
        </div>

        <!-- Tab Content -->
        <!-- Overview Tab -->
        <div class="tab-content active" id="overview-tab">
            <div class="dashboard-grid">
                <!-- Quick Stats -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3>Quick Stats</h3>
                        <i class="fas fa-chart-line card-icon"></i>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md); text-align: center;">
                        <div>
                            <div style="font-size: 2rem; font-weight: bold; color: var(--hardy-green);" id="active-count">0</div>
                            <div style="color: var(--text-secondary);">Active Listings</div>
                        </div>
                        <div>
                            <div style="font-size: 2rem; font-weight: bold; color: var(--hardy-green);" id="message-count">0</div>
                            <div style="color: var(--text-secondary);">Total Messages</div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3>Quick Actions</h3>
                        <i class="fas fa-bolt card-icon"></i>
                    </div>
                    <div style="display: grid; gap: var(--spacing-md);">
                        <a class='btn btn-primary' href='/pages/create'>
                            <i class="fas fa-plus"></i> Create New Listing
                        </a>
                        <a class='btn btn-secondary' href='/pages/browse'>
                            <i class="fas fa-search"></i> Browse Listings
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Listings Tab -->
        <div class="tab-content" id="listings-tab">
            <div class="dashboard-card" style="max-width: none;">
                <div class="card-header">
                    <h3>My Listings</h3>
                    <a class='btn btn-primary btn-small' href='/pages/create'>
                        <i class="fas fa-plus"></i> Create New
                    </a>
                </div>
                
                <div class="listings-section" id="my-listings">
                    <div class="empty-state">
                        <i class="fas fa-seedling"></i>
                        <p>Loading your listings...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Messages Tab -->
        <div class="tab-content" id="messages-tab">
            <!-- Mobile toggle buttons (only visible on mobile) -->
            <div class="mobile-message-toggle">
                <button class="toggle-btn active" onclick="showMobileConversations()">
                    <i class="fas fa-comments"></i> Conversations
                </button>
                <button class="toggle-btn" onclick="showMobileMessageView()">
                    <i class="fas fa-comment"></i> Messages
                </button>
            </div>
            
            <div class="messages-container" id="messages-container">
                <!-- Conversations List -->
                <div class="conversations-list" id="conversations-list">
                    <div class="conversations-header">
                        <i class="fas fa-comments"></i> Conversations
                    </div>
                    <div id="conversations-content">
                        <div class="empty-state">
                            <p>Loading conversations...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Message View -->
                <div class="message-view" id="message-view">
                    <div class="no-conversation-selected">
                        <div>
                            <i class="fas fa-comments" style="font-size: 3rem; color: var(--border-color); margin-bottom: var(--spacing-md);"></i>
                            <p>Select a conversation to start messaging</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div class="tab-content" id="settings-tab">
            <div class="dashboard-card" style="max-width: 600px; margin: 0 auto;">
                <div class="card-header">
                    <h3>Account Settings</h3>
                    <i class="fas fa-cog card-icon"></i>
                </div>
                <p style="color: var(--text-secondary);">Manage your profile and account preferences.</p>
                
                <div class="settings-grid" style="margin-top: var(--spacing-lg);">
                    <button class="btn btn-outline" onclick="window.location.href='/pages/edit-profile.html'">
                        <i class="fas fa-user"></i> Edit Profile
                    </button>
                    <button class="btn btn-outline" onclick="updateNeighborhood()">
                        <i class="fas fa-map-marker-alt"></i> Update Neighborhood
                    </button>
                    <button class="btn btn-outline" onclick="signOut()">
                        <i class="fas fa-sign-out-alt"></i> Sign Out
                    </button>
                </div>
            </div>
        </div>
    </div>

    <footer class="site-footer">
        <div class="container">
            <div class="footer-content">
                <div>
                    <div class="footer-logo">
                        <img src="../img/logo-white.svg" alt="Hardy Home and Garden">
                    </div>
                    <p>The community garden in your pocket.</p>
                </div>
                <div class="footer-links">
                    <h3>Quick Links</h3>
                    <ul>
                        <li><a href='/'>Home</a></li>
                        <li><a href='/pages/browse'>Browse</a></li>
                        <li><a href='/pages/about'>About Hardy</a></li>
                        <li><a href='/pages/faq'>FAQ</a></li>
                        <li><a href='/pages/contact'>Contact</a></li>
                    </ul>
                </div>
                <div class="footer-links">
                    <h3>Get Started</h3>
                    <ul>
                        <li><a href='/pages/auth'>Sign In</a></li>
                        <li><a href='/pages/create'>Create Listing</a></li>
                        <li><a href='/pages/auth'>Join Hardy</a></li>
                    </ul>
                </div>
                <div class="footer-links">
                    <h3>Legal</h3>
                    <ul>
                        <li><a href='/pages/terms'>Terms of Use</a></li>
                        <li><a href='/pages/privacy'>Privacy Policy</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Hardy Home and Garden. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- V2 Dashboard Scripts - Simplified Messaging -->
    <script>
        let currentUser = null;
        let userProfile = null;
        let userListings = [];
        let messagesByListing = {};
        let currentListingId = null;
        let messagesSubscription = null;
        
        // Check if user is logged in
        document.addEventListener('DOMContentLoaded', async function() {
            // Check auth using v2 function
            const authResult = await checkAuth();
            
            if (!authResult.isAuthenticated || !authResult.user) {
                // Redirect to auth page if not logged in
                window.location.href = 'auth.html?redirect=dashboard';
                return;
            }
            
            currentUser = authResult.user;
            
            // Get user profile
            const { data: profile, error } = await window.hardySupabase
                .from('profiles')
                .select('*')
                .eq('id', currentUser.id)
                .single();
            
            if (error || !profile) {
                console.error('Error fetching profile:', error);
                userProfile = {
                    id: currentUser.id,
                    full_name: currentUser.user_metadata?.full_name || currentUser.email?.split('@')[0],
                    email: currentUser.email,
                    created_at: currentUser.created_at
                };
            } else {
                userProfile = profile;
            }
            
            // Update UI with user info
            updateUserInfo(userProfile);
            
            // Load initial data
            await Promise.all([
                loadUserListings(),
                loadMessages()
            ]);
            
            // Setup components
            setupUserDropdown();
            setupMobileMenu();
            setupRealtimeSubscriptions();
        });
        
        // Tab switching
        function switchTab(tabName, event) {
            if (event && event.preventDefault) {
                event.preventDefault();
            }
            
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('onclick')?.includes(`'${tabName}'`)) {
                    btn.classList.add('active');
                }
            });
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            const targetTab = document.getElementById(`${tabName}-tab`);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // If switching to messages tab on mobile, show conversations by default
            if (tabName === 'messages' && window.innerWidth <= 768) {
                showMobileConversations();
            }
        }
        
        // Update user info in header
        function updateUserInfo(profile) {
            let displayName = 'Friend';
            
            if (profile) {
                displayName = profile.nickname || profile.full_name || profile.email?.split('@')[0] || 'Friend';
            }
            
            document.getElementById('welcome-name').textContent = displayName;
            document.getElementById('user-name').textContent = displayName;
            document.getElementById('user-avatar').textContent = displayName.charAt(0).toUpperCase();
            
            // Update neighborhood
            if (profile?.neighborhood) {
                document.getElementById('user-neighborhood').textContent = profile.neighborhood;
            } else if (profile?.zip_code) {
                document.getElementById('user-neighborhood').textContent = getZipDisplayName(profile.zip_code);
            }
            
            // Update member date
            if (profile?.created_at) {
                const memberDate = new Date(profile.created_at);
                document.getElementById('member-date').textContent = memberDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            }
        }
        
        // Load user listings (same as before with auto-expire)
        async function loadUserListings() {
            try {
                const { data: listings, error } = await window.hardySupabase
                    .from('listings')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                // Filter out expired listings
                const now = new Date();
                userListings = (listings || []).filter(listing => {
                    if (!listing.expires_at) return true;
                    return new Date(listing.expires_at) > now;
                });
                
                displayUserListings();
                
                // Update stats
                const activeCount = userListings.filter(l => l.is_active).length;
                document.getElementById('active-count').textContent = activeCount;
                
            } catch (error) {
                console.error('Error loading listings:', error);
            }
        }
        
        // Display user listings (same as before)
        function displayUserListings() {
            const container = document.getElementById('my-listings');
            
            if (userListings.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-seedling"></i>
                        <p>No listings yet</p>
                        <p style="font-size: 0.9rem;">Create your first listing to start sharing with your community!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            userListings.forEach(listing => {
                const item = createListingItem(listing);
                container.appendChild(item);
            });
        }
        
        function createListingItem(listing) {
            const item = document.createElement('div');
            item.className = 'listing-item';
            
            const listingTypeClass = listing.listing_type === 'seeking' ? 'seeking' : 'offering';
            const listingTypeText = listing.listing_type === 'seeking' ? 'Seeking' : 'Offering';
            
            item.innerHTML = `
                <div class="listing-info">
                    <div class="listing-type ${listingTypeClass}">${listingTypeText}</div>
                    <div class="listing-title">${escapeHtml(listing.title)}</div>
                    <div class="listing-meta">
                        ${listing.category} • ${listing.availability}
                    </div>
                </div>
                <div class="listing-actions">
                    <button class="btn btn-secondary btn-small" onclick="editListing('${listing.id}')">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button class="btn btn-outline btn-small" onclick="deleteListing('${listing.id}')">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            `;
            
            return item;
        }
        
        // V2: Load messages using simplified structure
        async function loadMessages() {
            try {
                // Get all messages where user is sender or recipient
                const result = await getMyMessages();
                
                if (!result.success) {
                    throw new Error(result.error);
                }
                
                messagesByListing = result.messagesByListing;
                displayConversations();
                updateUnreadCount();
                
                // Update message count stat
                let totalMessages = 0;
                Object.values(messagesByListing).forEach(conv => {
                    totalMessages += conv.messages.length;
                });
                document.getElementById('message-count').textContent = totalMessages;
                
            } catch (error) {
                console.error('Error loading messages:', error);
                document.getElementById('conversations-content').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Error loading messages</p>
                        <button class="btn btn-primary btn-small" onclick="loadMessages()">Retry</button>
                    </div>
                `;
            }
        }
        
        // V2: Display conversations grouped by listing
        function displayConversations() {
            const container = document.getElementById('conversations-content');
            
            const listings = Object.keys(messagesByListing);
            if (listings.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>No conversations yet</p>
                        <p style="font-size: 0.9rem;">Start by contacting someone about their listing!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            // Sort by most recent message
            const sortedListings = listings.sort((a, b) => {
                const aMessages = messagesByListing[a].messages;
                const bMessages = messagesByListing[b].messages;
                const aTime = aMessages[0]?.created_at || '1970-01-01';
                const bTime = bMessages[0]?.created_at || '1970-01-01';
                return new Date(bTime) - new Date(aTime);
            });
            
            sortedListings.forEach(listingId => {
                const conv = messagesByListing[listingId];
                const item = createConversationItem(listingId, conv);
                container.appendChild(item);
            });
        }
        
        // V2: Create conversation item
        function createConversationItem(listingId, conv) {
            const item = document.createElement('div');
            item.className = 'conversation-item';
            
            if (conv.unreadCount > 0) {
                item.classList.add('unread');
            }
            
            if (currentListingId === listingId) {
                item.classList.add('active');
            }
            
            const lastMessage = conv.messages[0];
            const timeAgo = lastMessage ? formatTimeAgo(lastMessage.created_at) : '';
            
            // Get other user's display name
            const otherUserName = conv.otherUser?.nickname || 
                                conv.otherUser?.full_name || 
                                'Unknown User';
            
            item.innerHTML = `
                <div class="conversation-header">
                    <div class="conversation-user">${otherUserName}</div>
                    <div class="conversation-time">${timeAgo}</div>
                </div>
                <div class="conversation-listing">${conv.listing?.title || 'Deleted Listing'}</div>
                <div class="conversation-preview">
                    ${lastMessage ? escapeHtml(lastMessage.content) : 'No messages yet'}
                </div>
            `;
            
            item.onclick = () => selectConversation(listingId);
            
            return item;
        }
        
        // V2: Select conversation
        async function selectConversation(listingId) {
            currentListingId = listingId;
            
            // Update active state
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            // Display messages
            displayMessages(listingId);
            
            // Mark as read
            await markMessagesRead(listingId);
            
            // Reload to update unread counts
            await loadMessages();
            
            // On mobile, switch to message view
            if (window.innerWidth <= 768) {
                showMobileMessageView();
            }
        }
        
        // V2: Display messages for a listing
        function displayMessages(listingId) {
            const messageView = document.getElementById('message-view');
            const conv = messagesByListing[listingId];
            
            if (!conv) return;
            
            const otherUserName = conv.otherUser?.nickname || 
                                conv.otherUser?.full_name || 
                                'Unknown User';
            
            messageView.innerHTML = `
                <div class="message-header">
                    <button class="mobile-back-btn" onclick="showMobileConversations()" style="display: none;">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <h3>${otherUserName}</h3>
                    <div class="message-listing-info">
                        Regarding: ${conv.listing?.title || 'Deleted Listing'}
                    </div>
                </div>
                <div class="messages-area" id="messages-area">
                    ${conv.messages.map(msg => createMessageElement(msg)).join('')}
                </div>
                <div class="message-input-area">
                    <form class="message-input-form" onsubmit="sendMessageV2(event, '${listingId}', '${conv.otherUser.id}')">
                        <textarea 
                            class="message-input" 
                            id="message-input"
                            placeholder="Type your message..." 
                            rows="2"
                            required
                        ></textarea>
                        <button type="submit" class="send-btn">
                            <i class="fas fa-paper-plane"></i> Send
                        </button>
                    </form>
                </div>
            `;
            
            // Scroll to bottom
            const messagesArea = document.getElementById('messages-area');
            messagesArea.scrollTop = messagesArea.scrollHeight;
            
            // Show back button on mobile
            if (window.innerWidth <= 768) {
                const backBtn = messageView.querySelector('.mobile-back-btn');
                if (backBtn) backBtn.style.display = 'flex';
            }
        }
        
        // Create message element
        function createMessageElement(message) {
            const isSent = message.sender_id === currentUser.id;
            const senderName = message.sender?.nickname || 
                             message.sender?.full_name || 
                             'Unknown';
            const senderInitial = senderName.charAt(0).toUpperCase();
            
            return `
                <div class="message ${isSent ? 'sent' : 'received'}">
                    <div class="message-avatar">${senderInitial}</div>
                    <div class="message-content">
                        <div class="message-bubble">
                            ${escapeHtml(message.content)}
                        </div>
                        <div class="message-time">${formatTime(message.created_at)}</div>
                    </div>
                </div>
            `;
        }
        
        // V2: Send message using simplified function
        async function sendMessageV2(event, listingId, recipientId) {
            event.preventDefault();
            
            const input = document.getElementById('message-input');
            const sendBtn = event.target.querySelector('.send-btn');
            const content = input.value.trim();
            
            if (!content) return;
            
            try {
                sendBtn.disabled = true;
                sendBtn.textContent = 'Sending...';
                
                // Use v2 sendMessage function
                const result = await sendMessage(listingId, recipientId, content);
                
                if (!result.success) {
                    throw new Error(result.error);
                }
                
                // Clear input
                input.value = '';
                
                // Reload messages
                await loadMessages();
                
                // Redisplay current conversation
                displayMessages(listingId);
                
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Failed to send message. Please try again.');
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send';
            }
        }
        
        // Update unread count
        function updateUnreadCount() {
            let unreadCount = 0;
            
            Object.values(messagesByListing).forEach(conv => {
                unreadCount += conv.unreadCount;
            });
            
            const badge = document.getElementById('unread-badge');
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }
        
        // Setup realtime subscriptions for v2
        function setupRealtimeSubscriptions() {
            // Subscribe to new messages where user is recipient
            window.hardySupabase
                .channel('my-messages')
                .on('postgres_changes',
                    {
                        event: 'INSERT',
                        schema: 'public',
                        table: 'messages_v2',
                        filter: `recipient_id=eq.${currentUser.id}`
                    },
                    async () => {
                        // Reload messages when new one arrives
                        await loadMessages();
                        
                        // If viewing this conversation, update display
                        if (currentListingId) {
                            displayMessages(currentListingId);
                        }
                    }
                )
                .subscribe();
        }
        
        // Mobile functions
        function showMobileConversations() {
            const convList = document.getElementById('conversations-list');
            const msgView = document.getElementById('message-view');
            const toggleBtns = document.querySelectorAll('.mobile-message-toggle .toggle-btn');
            
            convList.classList.add('mobile-show');
            msgView.classList.remove('mobile-show');
            
            toggleBtns[0].classList.add('active');
            toggleBtns[1].classList.remove('active');
        }
        
        function showMobileMessageView() {
            const convList = document.getElementById('conversations-list');
            const msgView = document.getElementById('message-view');
            const toggleBtns = document.querySelectorAll('.mobile-message-toggle .toggle-btn');
            
            convList.classList.remove('mobile-show');
            msgView.classList.add('mobile-show');
            
            toggleBtns[0].classList.remove('active');
            toggleBtns[1].classList.add('active');
        }
        
        // Helper functions
        function formatTimeAgo(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diff = now - date;
            
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;
            
            return date.toLocaleDateString();
        }
        
        function formatTime(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true 
            });
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Edit/Delete listing functions
        function editListing(listingId) {
            window.location.href = `create.html?edit=${listingId}`;
        }
        
        async function deleteListing(listingId) {
            if (!confirm('Are you sure you want to delete this listing?')) {
                return;
            }
            
            try {
                const { error } = await window.hardySupabase
                    .from('listings')
                    .delete()
                    .eq('id', listingId)
                    .eq('user_id', currentUser.id);
                
                if (error) throw error;
                
                await loadUserListings();
                
            } catch (error) {
                console.error('Error deleting listing:', error);
                alert('Error deleting listing. Please try again.');
            }
        }
        
        // Neighborhood update
        async function updateNeighborhood() {
            const current = document.getElementById('user-neighborhood').textContent;
            const newNeighborhood = prompt('Enter your neighborhood:', current);
            
            if (newNeighborhood && newNeighborhood !== current) {
                try {
                    const { error } = await window.hardySupabase
                        .from('profiles')
                        .update({ neighborhood: newNeighborhood })
                        .eq('id', currentUser.id);
                    
                    if (error) throw error;
                    
                    document.getElementById('user-neighborhood').textContent = newNeighborhood;
                    alert('Neighborhood updated!');
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error updating neighborhood.');
                }
            }
        }
        
        // Setup user dropdown
        function setupUserDropdown() {
            const userMenuBtn = document.getElementById('user-menu-btn');
            const userDropdown = document.getElementById('user-dropdown');
            
            if (userMenuBtn && userDropdown) {
                userMenuBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    userDropdown.classList.toggle('show');
                });
                
                document.addEventListener('click', function() {
                    userDropdown.classList.remove('show');
                });
            }
        }
        
        // Mobile menu
        function setupMobileMenu() {
            const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
            if (mobileMenuBtn) {
                mobileMenuBtn.addEventListener('click', function() {
                    // Toggle mobile menu
                });
            }
        }
    </script>
</body>
</html>